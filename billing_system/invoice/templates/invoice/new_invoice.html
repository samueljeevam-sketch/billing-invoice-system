{% extends "base.html" %}

{% block title %}BillingPro | New Invoice{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: #F9FAFB;
  }
  .font-mono-custom { font-family: 'JetBrains Mono', monospace; }
  .tracking-micro { letter-spacing: 0.15em; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8" x-data="invoiceHandler()">

  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-2xl font-black text-slate-900 tracking-tight">New Invoice</h1>
      <p class="text-slate-500 text-[11px] font-bold uppercase tracking-widest mt-1">
        Issued on <span class="text-indigo-600 font-mono-custom">{% now "Y-m-d" %}</span>
      </p>
    </div>

    <a href="{% url 'invoice_list' %}"
       class="text-indigo-600 text-[11px] font-black uppercase tracking-widest hover:underline">
       Back to Ledger
    </a>
  </div>

  <form method="POST" class="bg-white border border-slate-100 rounded-[2rem] shadow-xl shadow-slate-200/40 p-8">
    {% csrf_token %}

    <!-- Customer / Ref -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
      <div>
        <label class="text-[10px] font-black uppercase tracking-micro text-slate-400 block mb-2">
          Customer
        </label>
        <select name="customer" required
          class="w-full bg-white border border-slate-200 rounded-xl px-4 py-2 text-[13px] font-semibold focus:ring-4 ring-indigo-50 outline-none">
          <option value="">Select customer</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="text-[10px] font-black uppercase tracking-micro text-slate-400 block mb-2">
          Invoice Reference
        </label>
        <input type="text" name="reference"
          placeholder="INV-001"
          class="w-full bg-white border border-slate-200 rounded-xl px-4 py-2 text-[13px] font-mono-custom focus:ring-4 ring-indigo-50 outline-none">
      </div>
    </div>

    <!-- Items -->
    <div class="overflow-x-auto mb-6">
      <table class="w-full border-collapse">
        <thead>
          <tr class="border-b border-slate-100">
            <th class="text-[10px] font-black uppercase tracking-micro text-slate-400 text-left py-3">Item</th>
            <th class="text-[10px] font-black uppercase tracking-micro text-slate-400 text-center">Qty</th>
            <th class="text-[10px] font-black uppercase tracking-micro text-slate-400 text-right">Rate</th>
            <th class="text-[10px] font-black uppercase tracking-micro text-slate-400 text-right">Total</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <template x-for="(item, index) in items" :key="index">
            <tr class="border-b border-slate-50">

              <!-- ITEM -->
              <td class="py-4 pr-3">
                <select name="product[]" x-model="item.productId"
                  @change="updatePrice(index, $event)"
                  class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-[13px]">
                  <option value="">Select product</option>
                  {% for product in products %}
                    <option value="{{ product.id }}" data-price="{{ product.price }}">
                      {{ product.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <!-- QTY -->
              <td class="py-4 text-center">
                <input type="number" name="qty[]" min="1"
                  x-model.number="item.qty"
                  class="w-16 bg-white border border-slate-200 rounded-xl text-center text-[13px] font-semibold">
              </td>

              <!-- RATE -->
              <td class="py-4 text-right">
                <input type="number" step="0.01" name="price[]"
                  x-model.number="item.price"
                  readonly
                  class="w-28 bg-slate-50 border border-slate-200 rounded-xl
                  text-right text-[13px] font-mono-custom">
              </td>

              <!-- TOTAL -->
              <td class="py-4 text-right font-mono-custom font-bold text-slate-900">
                ₹<span x-text="(item.qty * item.price).toFixed(2)"></span>
              </td>

              <!-- REMOVE -->
              <td class="py-4 text-right">
                <button type="button" @click="removeItem(index)"
                  x-show="items.length > 1"
                  class="text-rose-500 hover:text-rose-700 font-bold">
                  ✕
                </button>
              </td>

            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="flex justify-between items-center mt-8">
      <button type="button" @click="addItem()"
        class="text-indigo-600 text-[11px] font-black uppercase tracking-widest hover:underline">
        + Add Line Item
      </button>

      <div class="w-64 text-right">
        <div class="flex justify-between text-[13px] font-semibold border-b pb-2">
          <span class="text-slate-500">Subtotal</span>
          <span class="font-mono-custom">₹<span x-text="calculateTotal()"></span></span>
        </div>

        <input type="hidden" name="total" :value="calculateTotal()">

        <button
          class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl py-3 text-[11px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100">
          Save Invoice
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Alpine -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
function invoiceHandler() {
  return {
    items: [{ productId: '', qty: 1, price: 0 }],

    addItem() {
      this.items.push({ productId: '', qty: 1, price: 0 })
    },

    removeItem(i) {
      if (this.items.length > 1) this.items.splice(i, 1)
    },

    updatePrice(i, e) {
      const selected = e.target.options[e.target.selectedIndex]
      const price = selected.getAttribute("data-price")
      this.items[i].price = price ? parseFloat(price) : 0
    },

    calculateTotal() {
      return this.items
        .reduce((sum, item) => sum + (item.qty * item.price), 0)
        .toFixed(2)
    }
  }
}
</script>

{% endblock %}
